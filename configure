#!/bin/sh
set -e

cd "$(dirname "$0")"

# Defaults
[ -z "$CC" ] && CC="cc"
[ -z "$CFLAGS" ] && CFLAGS="--std=c99 -Werror -Wall -Wextra -Wpedantic -O2 -D_DEFAULT_SOURCE"
[ -z "$LDFLAGS" ] && LDFLAGS=""

set -u

target=noded
includes="include/noded.h include/ast.h include/dict.h include/vm.h test/vm-framework.h"

debug_flags=false

bins () {
    # Anatomy: mkbin TYPE NAME OBJECTS...
    mkbin target "$target" src/alloc src/ast src/compiler src/dict \
             src/err src/noded src/parser src/scanner src/token src/vm
    mkbin tool disasm src/alloc tools/disasm
    mkbin tool compile src/alloc src/ast src/compiler src/dict src/err \
           src/parser src/scanner src/token tools/compile
    mkbin test test-vm src/alloc src/vm \
           test/test-vm test/vm-framework
    mkbin test test-compiler src/alloc src/ast src/compiler \
           src/dict src/err src/parser src/scanner src/token src/vm \
           test/test-compiler test/vm-framework
}

for i in "$@"; do
    case $i in
        CC=*)
            CC="${i#*=}"
            ;;
        CFLAGS=*)
            CFLAGS="${i#*=}"
            ;;
        LDFLAGS=*)
            LDFLAGS="${i#*=}"
            ;;
        --debug)
            debug_flags=true
            ;;
        --help | -h)
            cat <<EOF
Noded programming language configuration program.

Variables that will be exported to the makefile:

    CC                 The C compiler to be used to compile noded.
                       (default: cc)
    CFLAGS             The C flags.
                       (default: --std=c99 -Werror -Wall -Wextra -Wpedantic -D_DEFAULT_SOURCE)
    LDFLAGS            The C link flags.
                       (default: none)
Available options:
    --debug            Append debug flags to the compiler

    --help             Shows this help.
EOF
            exit 0
            ;;
        *)
            echo "Unknown option: $i"
            exit 1
            ;;
    esac
done

if $debug_flags; then
    CFLAGS="$CFLAGS -g -O0"
else
    CFLAGS="$CFLAGS -DNDEBUG"
fi

echo "CC=$CC"
echo "CFLAGS=$CFLAGS"
echo "LDFLAGS=$LDFLAGS"
# Create the main Makefile
sed "
s|@@TARGET@@|$target|g;
s|@@CC@@|$CC|g;
s|@@CFLAGS@@|$CFLAGS|g;
s|@@LDFLAGS@@|$LDFLAGS|g;
s|@@INCLUDES@@|$includes|g
" < Makefile.in > Makefile

src () {
    echo "$1.c"
}

obj () {
    echo "build/${1#*/}.o"
}

objs () {
    for obj in "$@"; do
        echo `obj $obj`
    done
}

inline () {
    tr '\n' ' '
}

echo "# build.make" > build.make

# OBJECTS = ...
mkbin () {
    shift 2
    objs "$@"
}
echo "OBJECTS = `bins | sort -u | inline`" >> build.make

# TOOLS = ...
mkbin () {
    if [ "$1" = "tool" ]; then
        echo "$2"
    fi
}

echo "TOOLS = `bins | inline`" >> build.make

# TESTS = ...
mkbin () {
    if [ "$1" = "test" ]; then
        echo "$2"
    fi
}

echo "TESTS = `bins | inline`" >> build.make
echo >> build.make

# tools: ...
echo 'tools: $(TOOLS)' >> build.make
echo >> build.make

# test: ...
mkbin () {
    if [ "$1" = "test" ]; then
        printf '\t./%s\n' "$2"
    fi
}

echo 'test: $(TESTS)' >> build.make
bins >> build.make
echo >> build.make

# Building binaries
mkbin () {
    name="$2"
    shift 2
    objs="`objs "$@" | inline`"
    printf '%s: %s\n' "$name" "$objs"
    printf '\t$(CC) $(LDFLAGS) -o $@ %s\n' "$objs"
    echo
}

bins >> build.make

# Building object files
mkbin () {
    shift 2
    echo "$@" | tr ' ' '\n'
}

for obj in `bins | sort -u | inline`; do
    printf '%s: %s $(INCLUDES)\n' `obj $obj` `src $obj`
    printf '\t@mkdir -p build\n'
    printf '\t$(CC) $(CFLAGS) -o $@ -c %s\n' `src $obj`
done >> build.make

exit 0
